<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="text-main">
    <i class="bi bi-graph-up me-2"></i>Графики для <%= @patient.full_name %>
  </h2>
  <div>
    <a href="/patients/<%= @patient.id %>/print" class="btn btn-main me-2" target="_blank">
      <i class="bi bi-printer me-1"></i>Печатать
    </a>
    <a href="/patients/<%= @patient.id %>/partogram" class="btn btn-secondary">
      <i class="bi bi-arrow-left me-1"></i>Назад к партограмме
    </a>
  </div>
</div>

<div class="card mb-4">
  <div class="card-header bg-main text-white">
    <h5 class="mb-0"><i class="bi bi-heart-pulse me-2"></i>Сердцебиение плода</h5>
  </div>
  <div class="card-body">
    <canvas id="heartRateChart" height="100"></canvas>
  </div>
</div>

<div class="card mb-4">
  <div class="card-header bg-main text-white">
    <h5 class="mb-0"><i class="bi bi-activity me-2"></i>Раскрытие шейки матки и схватки</h5>
  </div>
  <div class="card-body">
    <canvas id="cervixContractionsChart" height="100"></canvas>
  </div>
</div>

<div class="card mb-4">
  <div class="card-header bg-main text-white">
    <h5 class="mb-0"><i class="bi bi-droplet me-2"></i>Артериальное давление и пульс</h5>
  </div>
  <div class="card-body">
    <canvas id="pressurePulseChart" height="100"></canvas>
  </div>
</div>

<div class="card mb-4">
  <div class="card-header bg-main text-white">
    <h5 class="mb-0"><i class="bi bi-thermometer me-2"></i>Температура</h5>
  </div>
  <div class="card-body">
    <canvas id="temperatureChart" height="100"></canvas>
  </div>
</div>

<div class="card">
  <div class="card-header bg-main text-white">
    <h5 class="mb-0"><i class="bi bi-table me-2"></i>Таблица всех показателей</h5>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-striped table-bordered" id="measurementsTable">
        <thead class="table-light">
          <tr>
            <th>Дата и время</th>
            <th>Сердцебиение</th>
            <th>Раскрытие (см)</th>
            <th>Положение головки</th>
            <th>Схватки</th>
            <th>Околоплодные воды</th>
            <th>Пульс</th>
            <th>АД (сист/диаст)</th>
            <th>Температура</th>
            
            
            
            <th>Моча</th>
            <th>Медикаменты</th>
          </tr>
        </thead>
        <tbody>
          <% @measurements.each do |measurement| %>
            <tr>
              <td>
                <small class="text-muted"><%= measurement.measurement_time.strftime('%d.%m.%Y') %></small><br>
                <%= measurement.measurement_time.strftime('%H:%M') %>
              </td>
              <td><%= measurement.fetal_heart_rate %></td>
              <td><%= measurement.cervix_dilation %></td>
              <td><%= measurement.head_position %></td>
              <td><%= measurement.uterine_contractions %></td>
              <td><%= measurement.amniotic_fluid %></td>
              <td><%= measurement.pulse %></td>
              <td><%= measurement.systolic_bp %>/<%= measurement.diastolic_bp %></td>
              <td><%= measurement.temperature %></td>
              
             
             
              <td><%= measurement.urine %></td>
              <td><%= measurement.medications %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const measurements = <%= @measurements.to_json %>;
  
  // Форматируем данные для графиков
  const labels = measurements.map(m => {
    const date = new Date(m.measurement_time);
    return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
  });
  
  // График сердцебиения плода
  new Chart(document.getElementById('heartRateChart'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Сердцебиение плода (уд/мин)',
        data: measurements.map(m => m.fetal_heart_rate),
        borderColor: '#dc3545',
        backgroundColor: 'rgba(220, 53, 69, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: true
        }
      },
      scales: {
        y: {
          beginAtZero: false,
          min: 100,
          max: 160,
          title: {
            display: true,
            text: 'Удары в минуту'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Время'
          }
        }
      }
    }
  });
  
  // График раскрытия шейки матки и схваток
  new Chart(document.getElementById('cervixContractionsChart'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Раскрытие шейки матки (см)',
          data: measurements.map(m => m.cervix_dilation),
          borderColor: '#54c654',
          backgroundColor: 'rgba(84, 198, 84, 0.1)',
          tension: 0.4,
          fill: true,
          yAxisID: 'y'
        },
        {
          label: 'Схватки (за 10 мин)',
          data: measurements.map(m => m.uterine_contractions),
          borderColor: '#ffc107',
          backgroundColor: 'rgba(255, 193, 7, 0.1)',
          tension: 0.4,
          fill: true,
          yAxisID: 'y1'
        }
      ]
    },
    options: {
      responsive: true,
      interaction: {
        mode: 'index',
        intersect: false,
      },
      scales: {
        y: {
          type: 'linear',
          display: true,
          position: 'left',
          min: 0,
          max: 10,
          title: {
            display: true,
            text: 'Раскрытие (см)'
          }
        },
        y1: {
          type: 'linear',
          display: true,
          position: 'right',
          min: 0,
          max: 10,
          title: {
            display: true,
            text: 'Схватки'
          },
          grid: {
            drawOnChartArea: false,
          },
        },
        x: {
          title: {
            display: true,
            text: 'Время'
          }
        }
      }
    }
  });
  
  // График давления и пульса
  new Chart(document.getElementById('pressurePulseChart'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'АД систолическое',
          data: measurements.map(m => m.systolic_bp),
          borderColor: '#dc3545',
          backgroundColor: 'rgba(220, 53, 69, 0.1)',
          tension: 0.4,
          fill: false
        },
        {
          label: 'АД диастолическое',
          data: measurements.map(m => m.diastolic_bp),
          borderColor: '#6f42c1',
          backgroundColor: 'rgba(111, 66, 193, 0.1)',
          tension: 0.4,
          fill: false
        },
        {
          label: 'Пульс',
          data: measurements.map(m => m.pulse),
          borderColor: '#fd7e14',
          backgroundColor: 'rgba(253, 126, 20, 0.1)',
          tension: 0.4,
          fill: false
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: false,
          min: 40,
          max: 200,
          title: {
            display: true,
            text: 'Значение'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Время'
          }
        }
      }
    }
  });
  
  // График температуры
  new Chart(document.getElementById('temperatureChart'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Температура (°C)',
        data: measurements.map(m => m.temperature),
        borderColor: '#17a2b8',
        backgroundColor: 'rgba(23, 162, 184, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: false,
          min: 36,
          max: 39,
          title: {
            display: true,
            text: 'Температура (°C)'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Время'
          }
        }
      }
    }
  });
  
  // Добавляем сортировку для таблицы
  const table = document.getElementById('measurementsTable');
  if (table) {
    const headers = table.querySelectorAll('thead th');
    headers.forEach((header, index) => {
      header.style.cursor = 'pointer';
      header.addEventListener('click', () => {
        sortTable(index);
      });
    });
    
    function sortTable(column) {
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      
      rows.sort((a, b) => {
        const aText = a.cells[column].textContent.trim();
        const bText = b.cells[column].textContent.trim();
        
        // Попытка численного сравнения
        const aNum = parseFloat(aText);
        const bNum = parseFloat(bText);
        
        if (!isNaN(aNum) && !isNaN(bNum)) {
          return aNum - bNum;
        }
        
        // Сравнение дат
        const aDate = new Date(aText);
        const bDate = new Date(bText);
        if (!isNaN(aDate) && !isNaN(bDate)) {
          return aDate - bDate;
        }
        
        // Текстовое сравнение
        return aText.localeCompare(bText);
      });
      
      // Удаляем существующие строки
      while (tbody.firstChild) {
        tbody.removeChild(tbody.firstChild);
      }
      
      // Добавляем отсортированные строки
      rows.forEach(row => tbody.appendChild(row));
    }
  }
});
</script>