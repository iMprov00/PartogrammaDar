<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="h3 mb-0">Партограмма: <%= @patient.full_name %></h1>
  <div>
    <% unless @patient.delivery_completed %>
      <form method="post" action="/patients/<%= @patient.id %>/complete_delivery" class="d-inline">
        <button type="submit" class="btn btn-success me-2">
          <i class="bi bi-check-circle"></i> Завершить роды
        </button>
      </form>
    <% end %>
    <a href="/patients/<%= @patient.id %>/print" class="btn btn-main me-2" target="_blank">
      <i class="bi bi-printer me-1"></i>Печатать
    </a>
    <a href="/patients/<%= @patient.id %>/charts" class="btn btn-main me-2">
      <i class="bi bi-graph-up me-1"></i>Графики
    </a>
    <a href="/patients" class="btn btn-secondary">
      <i class="bi bi-arrow-left"></i> Назад к списку
    </a>
  </div>
</div>

<div class="row">
  <div class="col-lg-8">
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Таймер измерений</h5>
        <span class="status-badge badge bg-<%= @patient.status == 'роды завершены' ? 'success' : @patient.status == 'в родах' ? 'warning' : 'secondary' %>">
          <%= @patient.status %>
        </span>
      </div>
      <div class="card-body">
        <% if @patient.status == 'в родах' && !@patient.delivery_completed %>
          <div id="partogram-timer" class="text-center py-4">
            <div id="timer-display" class="display-4 fw-bold mb-3 timer-<%= @patient.timer_status %>">
              <span id="timer-minutes"><%= @patient.minutes_since_last_measurement || 0 %></span>:<span id="timer-seconds">00</span>
            </div>
            <p class="text-muted mb-3">
              <% if @patient.last_measurement_time %>
                Последнее измерение: <span id="last-measurement-time"><%= @patient.last_measurement_time.strftime('%H:%M') %></span>
              <% else %>
                Измерения еще не проводились
              <% end %>
            </p>
            <div id="timer-alert" class="alert alert-info">

              <span id="timer-message">Новые измерения должны проводиться каждые 30 минут</span>
            </div>
          </div>
        <% elsif @patient.delivery_completed %>
          <div class="text-center py-4">
            <i class="bi bi-check-circle display-1 text-success"></i>
            <h4 class="text-success mt-3">Роды завершены</h4>
            <p class="text-muted">Таймер измерений отключен</p>
          </div>
        <% else %>
          <div class="text-center py-4">
            <i class="bi bi-clock display-1 text-muted"></i>
            <h4 class="text-muted mt-3">Роды еще не начались</h4>
            <p class="text-muted">Таймер активируется после первого измерения</p>
          </div>
        <% end %>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">История измерений</h5>
      </div>
      <div class="card-body">
        <% if @measurements.any? %>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Дата и время</th>
                  <th>Сердцебиение</th>
                  <th>Положение головки</th>
                  <th>Раскрытие</th>
                  <th>Сокращения</th>
                  <th>Пульс</th>
                  <th>АД</th>
                  <th>Температура</th>
                  <th>Воды</th>
                  <th>Моча</th>
                  <th>Лек.средства</th>
                  <th>Действия</th>
                </tr>
              </thead>
              <tbody>
                <% @measurements.each do |measurement| %>
                  <tr>
                    <td>
                      <small class="text-muted"><%= measurement.measurement_time.strftime('%d.%m.%Y') %></small><br>
                      <%= measurement.measurement_time.strftime('%H:%M') %>
                    </td>
                    <td><%= measurement.fetal_heart_rate %> уд/мин</td>
                    <td><%= measurement.head_position %></td>
                    <td><%= measurement.cervix_dilation %> см</td>
                    <td><%= measurement.uterine_contractions %></td>
                    <td><%= measurement.pulse %></td>
                    <td><%= measurement.systolic_bp %>/<%= measurement.diastolic_bp %></td>
                    <td><%= measurement.temperature %> °C</td>
                    <td><%= measurement.amniotic_fluid %></td>
                    <td><%= measurement.urine %></td>
                    <td><%= measurement.medications %></td>
                    <td>
                      <div class="btn-group btn-group-sm">
                        <a href="/patients/<%= @patient.id %>/measurements/<%= measurement.id %>/edit" 
                           class="btn btn-outline-primary" 
                           title="Редактировать">
                          <i class="bi bi-pencil"></i>
                        </a>
                        <form method="post" 
                              action="/patients/<%= @patient.id %>/measurements/<%= measurement.id %>" 
                              class="d-inline"
                              onsubmit="return confirm('Вы уверены, что хотите удалить это измерение?')">
                          <input type="hidden" name="_method" value="DELETE">
                          <button type="submit" class="btn btn-outline-danger" title="Удалить">
                            <i class="bi bi-trash"></i>
                          </button>
                        </form>
                      </div>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="text-center py-4">
            <i class="bi bi-clipboard-x display-1 text-muted"></i>
            <h5 class="text-muted mt-3">Измерения отсутствуют</h5>
            <p class="text-muted">Добавьте первое измерение</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">Новое измерение</h5>
      </div>
       <div class="card-body">
        <form method="post" action="/patients/<%= @patient.id %>/measurements" id="measurement-form">
          <div class="mb-3">
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="use_current_time" checked>
              <label class="form-check-label" for="use_current_time">
                Использовать текущее время
              </label>
            </div>
            <label for="measurement_measurement_time" class="form-label">Время измерения</label>
            <input type="datetime-local" class="form-control" id="measurement_measurement_time" 
                   name="measurement[measurement_time]" 
                   value="<%= Time.now.strftime('%Y-%m-%dT%H:%M') %>" 
                   disabled>
          </div>

          <div class="row g-2">
            <div class="col-6">
              <label for="measurement_fetal_heart_rate" class="form-label">Сердцебиение плода</label>
              <input type="number" class="form-control" id="measurement_fetal_heart_rate" 
                     name="measurement[fetal_heart_rate]" min="60" max="200">
            </div>
            
            <div class="col-6">
              <label for="measurement_cervix_dilation" class="form-label">Раскрытие шейки (см)</label>
              <input type="number" class="form-control" id="measurement_cervix_dilation" 
                     name="measurement[cervix_dilation]" min="0" max="10" step="0.5">
            </div>
            
            <div class="col-6">
              <label for="measurement_head_position" class="form-label">Положение головки</label>
              <input type="number" class="form-control" id="measurement_head_position" 
                     name="measurement[head_position]" min="-5" max="5">
            </div>
            
            <div class="col-6">
              <label for="measurement_uterine_contractions" class="form-label">Сокращения/10мин</label>
              <input type="number" class="form-control" id="measurement_uterine_contractions" 
                     name="measurement[uterine_contractions]" min="0" max="10">
            </div>
            
            <div class="col-6">
              <label for="measurement_pulse" class="form-label">Пульс</label>
              <input type="number" class="form-control" id="measurement_pulse" 
                     name="measurement[pulse]" min="40" max="200">
            </div>
            
            <div class="col-6">
              <label for="measurement_temperature" class="form-label">Температура</label>
              <input type="number" class="form-control" id="measurement_temperature" 
                     name="measurement[temperature]" min="35" max="42" step="0.1">
            </div>
            
            <div class="col-6">
              <label for="measurement_systolic_bp" class="form-label">АД верхнее</label>
              <input type="number" class="form-control" id="measurement_systolic_bp" 
                     name="measurement[systolic_bp]" min="60" max="250">
            </div>
            
            <div class="col-6">
              <label for="measurement_diastolic_bp" class="form-label">АД нижнее</label>
              <input type="number" class="form-control" id="measurement_diastolic_bp" 
                     name="measurement[diastolic_bp]" min="40" max="150">
            </div>
            
            <div class="col-12">
              <label for="measurement_amniotic_fluid" class="form-label">Околоплодные воды</label>
              <select class="form-select" id="measurement_amniotic_fluid" name="measurement[amniotic_fluid]">
                <option value="">Выберите...</option>
                <option value="прозрачные">Прозрачные</option>
                <option value="зеленые">Зеленые</option>
                <option value="кровянистые">Кровянистые</option>
                <option value="отсутствуют">Отсутствуют</option>
              </select>
            </div>
            
            <div class="col-12">
              <label for="measurement_urine" class="form-label">Моча</label>
              <input type="text" class="form-control" id="measurement_urine" name="measurement[urine]">
            </div>
            
            <div class="col-12">
              <label for="measurement_medications" class="form-label">Лекарственные средства</label>
              <textarea class="form-control" id="measurement_medications" name="measurement[medications]" rows="2"></textarea>
            </div>
          </div>

          <button type="submit" class="btn btn-main w-100 mt-3">
            <i class="bi bi-plus-circle"></i> Добавить измерение
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="text-center text-muted small mb-2">
  Текущее время сервера: <%= Time.now.strftime('%d.%m.%Y %H:%M') %> |
  Локальное время: <span id="local-time"></span>
</div>
<script>
// Показываем локальное время пользователя для отладки
function updateLocalTime() {
  const now = new Date();
  document.getElementById('local-time').textContent = 
    now.toLocaleDateString('ru-RU') + ' ' + now.toLocaleTimeString('ru-RU');
}
setInterval(updateLocalTime, 1000);
updateLocalTime();
</script>

<script>
// Таймер в реальном времени
class PartogramTimer {
  constructor(patientId) {
    this.patientId = patientId;
    this.intervalId = null;
    this.isRunning = false;
  }

  start() {
    if (this.isRunning) return;
    
    this.isRunning = true;
    this.updateTimer();
    this.intervalId = setInterval(() => this.updateTimer(), 1000);
  }

  stop() {
    if (this.intervalId) {
      clearInterval(this.intervalId);
      this.intervalId = null;
    }
    this.isRunning = false;
  }

  async updateTimer() {
    try {
      const response = await fetch(`/timer/status/${this.patientId}`);
      const data = await response.json();
      
      this.updateDisplay(data);
    } catch (error) {
      console.error('Ошибка обновления таймера:', error);
    }
  }

  updateDisplay(data) {
    const timerDisplay = document.getElementById('timer-display');
    const timerMinutes = document.getElementById('timer-minutes');
    const timerSeconds = document.getElementById('timer-seconds');
    const timerAlert = document.getElementById('timer-alert');
    const timerMessage = document.getElementById('timer-message');

    if (!timerDisplay) return;

    // Обновляем статус таймера
    timerDisplay.className = `display-4 fw-bold mb-3 timer-${data.status}`;

    if (data.delivery_completed) {
      timerMinutes.textContent = '00';
      timerSeconds.textContent = '00';
      this.stop();
      return;
    }

    if (!data.labor_started) {
      timerMinutes.textContent = '00';
      timerSeconds.textContent = '00';
      return;
    }

    // Обновляем время
    const totalSeconds = data.seconds || 0;
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;

    timerMinutes.textContent = minutes.toString().padStart(2, '0');
    timerSeconds.textContent = seconds.toString().padStart(2, '0');

    // Обновляем сообщение и стиль предупреждения
    if (data.status === 'danger') {
      timerAlert.className = 'alert alert-danger';
      timerMessage.innerHTML = '<i class="bi bi-exclamation-triangle"></i> ТРЕВОГА! Превышено время измерения!';
    } else if (data.status === 'warning') {
      timerAlert.className = 'alert alert-warning';
      timerMessage.innerHTML = '<i class="bi bi-exclamation-circle"></i> Внимание! Скоро истечет время измерения';
    } else {
      timerAlert.className = 'alert alert-info';
      const timeLeft = data.time_until_next || 1800;
      const minutesLeft = Math.floor(timeLeft / 60);
      timerMessage.innerHTML = `<i class="bi bi-info-circle"></i> Новое измерение через: ${minutesLeft} мин ${timeLeft % 60} сек`;
    }
  }
}

// Инициализация таймера при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
  const patientId = '<%= @patient.id %>';
  const patientStatus = '<%= @patient.status %>';
  const deliveryCompleted = <%= @patient.delivery_completed %>;

  if (patientStatus === 'в родах' && !deliveryCompleted) {
    const timer = new PartogramTimer(patientId);
    timer.start();
  }
});
</script>

<script>
// Управление галочкой "текущее время"
document.addEventListener('DOMContentLoaded', function() {
  const useCurrentTimeCheckbox = document.getElementById('use_current_time');
  const timeInput = document.getElementById('measurement_measurement_time');
  const measurementForm = document.getElementById('measurement-form');
  
  if (useCurrentTimeCheckbox && timeInput) {
    // Функция для получения локального времени в правильном формате
    function getLocalDateTime() {
      const now = new Date();
      
      // Получаем компоненты локального времени
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    }
    
    // Функция для обновления текущего времени
    function updateCurrentTime() {
      timeInput.value = getLocalDateTime();
    }
    
    // Обработчик изменения галочки
    useCurrentTimeCheckbox.addEventListener('change', function() {
      if (this.checked) {
        timeInput.disabled = true;
        updateCurrentTime();
      } else {
        timeInput.disabled = false;
        setTimeout(() => timeInput.focus(), 100);
      }
    });
    
    // Обновляем время каждую минуту, если галочка активна
    setInterval(() => {
      if (useCurrentTimeCheckbox.checked) {
        updateCurrentTime();
      }
    }, 60000);
    
    // Обработчик отправки формы - ПРОСТО ОТПРАВЛЯЕМ ТО ЧТО В ПОЛЕ!
    measurementForm.addEventListener('submit', function(e) {
      if (useCurrentTimeCheckbox.checked) {
        // Просто включаем поле и отправляем то значение, которое в нем есть
        timeInput.disabled = false;
        // Значение уже установлено в правильном локальном времени
      }
    });
    
    // Инициализируем начальное состояние
    updateCurrentTime();
  }
});

</script>