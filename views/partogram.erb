<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">Партограмма: <%= @patient.full_name %></h1>
  <div class="d-flex align-items-center gap-2">
    <!-- Компактный таймер -->
    <% if @patient.status == 'в родах' && !@patient.delivery_completed %>
      <div class="compact-timer me-3">
        <div class="timer-badge bg-<%= @patient.timer_status == 'danger' ? 'danger' : @patient.timer_status == 'warning' ? 'warning' : 'success' %>">
          <i class="bi bi-clock me-1"></i>
          <span id="compact-timer-minutes"><%= @patient.minutes_since_last_measurement || 0 %></span>:<span id="compact-timer-seconds">00</span>
        </div>
        <small class="text-muted d-block mt-1">
          <% if @patient.last_measurement_time %>
            Последнее: <%= @patient.last_measurement_time.strftime('%H:%M') %>
          <% else %>
            Нет измерений
          <% end %>
        </small>
      </div>
    <% end %>

    <!-- Кнопки действий -->
    <div class="btn-group">
      <% unless @patient.delivery_completed %>
        <form method="post" action="/patients/<%= @patient.id %>/complete_delivery" class="d-inline">
          <button type="submit" class="btn btn-success btn-sm">
            <i class="bi bi-check-circle"></i> Завершить
          </button>
        </form>
      <% end %>
      <a href="/patients/<%= @patient.id %>/print" class="btn btn-main btn-sm" target="_blank">
        <i class="bi bi-printer"></i>
      </a>
      <a href="/patients/<%= @patient.id %>/charts" class="btn btn-main btn-sm">
        <i class="bi bi-graph-up"></i>
      </a>
      <a href="/patients/<%= @patient.id %>/who_partogram" class="btn btn-main btn-sm" target="_blank">
        <i class="bi bi-file-earmark-medical"></i>
      </a>
      <a href="/patients" class="btn btn-secondary btn-sm">
        <i class="bi bi-arrow-left"></i>
      </a>
    </div>
  </div>
</div>

<div class="row">
  <!-- Основной контент - форма и таблица -->
  <div class="col-12">
    <!-- Карточка формы измерений -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center py-2">
        <h6 class="mb-0">
          <i class="bi bi-plus-circle me-1"></i>Новое измерение
        </h6>
        <span class="badge bg-<%= @patient.status == 'роды завершены' ? 'success' : @patient.status == 'в родах' ? 'warning' : 'secondary' %>">
          <%= @patient.status %>
        </span>
      </div>
      <div class="card-body p-3">
        <form method="post" action="/patients/<%= @patient.id %>/measurements" id="measurement-form">
          <!-- Время измерения -->
          <div class="row mb-3">
            <div class="col-12">
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="use_current_time" checked>
                <label class="form-check-label" for="use_current_time">
                  Использовать текущее время
                </label>
              </div>
              <div class="input-group input-group-sm">
                <span class="input-group-text">Время измерения</span>
                <input type="datetime-local" class="form-control" id="measurement_measurement_time" 
                       name="measurement[measurement_time]" 
                       value="<%= Time.now.strftime('%Y-%m-%dT%H:%M') %>" 
                       disabled>
              </div>
            </div>
          </div>

          <!-- Аккордеон для разделов формы -->
          <div class="accordion" id="measurementAccordion">
            
            <!-- Поддерживающий уход -->
            <div class="accordion-item">
              <h6 class="accordion-header">
                <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSupport">
                  <i class="bi bi-heart-pulse me-2"></i>Поддерживающий уход
                </button>
              </h6>
              <div id="collapseSupport" class="accordion-collapse collapse" data-bs-parent="#measurementAccordion">
                <div class="accordion-body p-2">
                  <div class="row g-2">
                    <div class="col-md-6">
                      <label class="form-label small">Сопровождающее лицо</label>
                      <select class="form-select form-select-sm" name="measurement[companion_present]">
                        <option value="">Выберите...</option>
                        <% Measurement::COMPANION_OPTIONS.each do |option| %>
                          <option value="<%= option %>"><%= option %></option>
                        <% end %>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label small">Обезболивание</label>
                      <select class="form-select form-select-sm" name="measurement[pain_relief]">
                        <option value="">Выберите...</option>
                        <% Measurement::PAIN_RELIEF_OPTIONS.each do |option| %>
                          <option value="<%= option %>"><%= option %></option>
                        <% end %>
                      </select>
                    </div>
                    <!-- Остальные поля раздела... -->
                  </div>
                </div>
              </div>
            </div>

            <!-- Помощь ребенку -->
            <div class="accordion-item">
              <h6 class="accordion-header">
                <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBaby">
                  <i class="bi bi-baby me-2"></i>Помощь ребенку
                </button>
              </h6>
              <div id="collapseBaby" class="accordion-collapse collapse" data-bs-parent="#measurementAccordion">
                <div class="accordion-body p-2">
                  <div class="row g-2">
                    <div class="col-md-4">
                      <label class="form-label small">ЧСС плода</label>
                      <input type="number" class="form-control form-control-sm" name="measurement[fetal_heart_rate]" placeholder="уд/мин">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label small">Раскрытие</label>
                      <input type="number" class="form-control form-control-sm" name="measurement[cervix_dilation]" placeholder="см">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label small">Положение головки</label>
                      <input type="number" class="form-control form-control-sm" name="measurement[head_position]" placeholder="станция">
                    </div>
                    <!-- Остальные поля раздела... -->
                  </div>
                </div>
              </div>
            </div>

            <!-- Помощь матери -->
            <div class="accordion-item">
              <h6 class="accordion-header">
                <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMother">
                  <i class="bi bi-person-heart me-2"></i>Помощь матери
                </button>
              </h6>
              <div id="collapseMother" class="accordion-collapse collapse" data-bs-parent="#measurementAccordion">
                <div class="accordion-body p-2">
                  <div class="row g-2">
                    <div class="col-md-3">
                      <label class="form-label small">Пульс</label>
                      <input type="number" class="form-control form-control-sm" name="measurement[pulse]" placeholder="уд/мин">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label small">АД сист.</label>
                      <input type="number" class="form-control form-control-sm" name="measurement[systolic_bp]" placeholder="мм рт.ст.">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label small">АД диаст.</label>
                      <input type="number" class="form-control form-control-sm" name="measurement[diastolic_bp]" placeholder="мм рт.ст.">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label small">Температура</label>
                      <input type="number" class="form-control form-control-sm" name="measurement[temperature]" placeholder="°C" step="0.1">
                    </div>
                    <!-- Остальные поля раздела... -->
                  </div>
                </div>
              </div>
            </div>

            <!-- Ход родов -->
            <div class="accordion-item">
              <h6 class="accordion-header">
                <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLabor">
                  <i class="bi bi-graph-up me-2"></i>Ход родов
                </button>
              </h6>
              <div id="collapseLabor" class="accordion-collapse collapse" data-bs-parent="#measurementAccordion">
                <div class="accordion-body p-2">
                  <div class="row g-2">
                    <div class="col-md-4">
                      <label class="form-label small">Схватки</label>
                      <input type="number" class="form-control form-control-sm" name="measurement[uterine_contractions]" placeholder="за 10 мин">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label small">Продолжительность</label>
                      <input type="number" class="form-control form-control-sm" name="measurement[contractions_duration]" placeholder="сек">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label small">Воды</label>
                      <select class="form-select form-select-sm" name="measurement[amniotic_fluid]">
                        <option value="">Выберите...</option>
                        <% Measurement::AMNIOTIC_FLUID_OPTIONS.each do |option| %>
                          <option value="<%= option %>"><%= option %></option>
                        <% end %>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Лекарственные средства -->
            <div class="accordion-item">
              <h6 class="accordion-header">
                <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMeds">
                  <i class="bi bi-capsule me-2"></i>Лекарственные средства
                </button>
              </h6>
              <div id="collapseMeds" class="accordion-collapse collapse" data-bs-parent="#measurementAccordion">
                <div class="accordion-body p-2">
                  <div class="row g-2">
                    <div class="col-md-6">
                      <label class="form-label small">Окситоцин</label>
                      <select class="form-select form-select-sm" name="measurement[oxytocin]">
                        <option value="">Выберите...</option>
                        <% Measurement::OXYTOCIN_OPTIONS.each do |option| %>
                          <option value="<%= option %>"><%= option %></option>
                        <% end %>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label small">Дозировка</label>
                      <input type="text" class="form-control form-control-sm" name="measurement[oxytocin_dosage]" placeholder="Ед/л, кап./мин">
                    </div>
                    <div class="col-12">
                      <label class="form-label small">Другие средства</label>
                      <textarea class="form-control form-control-sm" name="measurement[other_medications]" rows="2" placeholder="Введите препараты..."></textarea>
                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>

          <button type="submit" class="btn btn-main w-100 mt-3 btn-sm">
            <i class="bi bi-plus-circle me-1"></i> Добавить измерение
          </button>
        </form>
      </div>
    </div>

    <!-- Таблица измерений -->
    <div class="card">
      <div class="card-header py-2">
        <h6 class="mb-0">
          <i class="bi bi-clock-history me-1"></i>История измерений
        </h6>
      </div>
      <div class="card-body p-0">
        <% if @measurements.any? %>
          <div class="table-responsive">
            <table class="table table-sm table-striped mb-0">
              <thead class="table-light">
                <tr>
                  <th width="120">Время</th>
                  <th width="80">ЧСС</th>
                  <th width="80">Раскрытие</th>
                  <th width="80">Головка</th>
                  <th width="80">Схватки</th>
                  <th width="70">Пульс</th>
                  <th width="90">АД</th>
                  <th width="80">Темп.</th>
                  <th width="80">Воды</th>
                  <th width="100">Действия</th>
                </tr>
              </thead>
              <tbody>
                <% @measurements.each do |measurement| %>
                  <tr>
                    <td>
                      <small class="text-muted"><%= measurement.measurement_time.strftime('%H:%M') %></small><br>
                      <small><%= measurement.measurement_time.strftime('%d.%m') %></small>
                    </td>
                    <td><%= measurement.fetal_heart_rate %></td>
                    <td><%= measurement.cervix_dilation %> см</td>
                    <td><%= measurement.head_position %></td>
                    <td><%= measurement.uterine_contractions %></td>
                    <td><%= measurement.pulse %></td>
                    <td><small><%= measurement.systolic_bp %>/<%= measurement.diastolic_bp %></small></td>
                    <td><%= measurement.temperature %>°</td>
                    <td><small><%= measurement.amniotic_fluid %></small></td>
                    <td>
                      <div class="btn-group btn-group-sm">
                        <a href="/patients/<%= @patient.id %>/measurements/<%= measurement.id %>/edit" 
                           class="btn btn-outline-primary btn-sm" title="Редактировать">
                          <i class="bi bi-pencil"></i>
                        </a>
                        <form method="post" action="/patients/<%= @patient.id %>/measurements/<%= measurement.id %>" 
                              class="d-inline"
                              onsubmit="return confirm('Удалить измерение?')">
                          <input type="hidden" name="_method" value="DELETE">
                          <button type="submit" class="btn btn-outline-danger btn-sm" title="Удалить">
                            <i class="bi bi-trash"></i>
                          </button>
                        </form>
                      </div>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="text-center py-4">
            <i class="bi bi-clipboard-x display-6 text-muted mb-3"></i>
            <h6 class="text-muted">Измерения отсутствуют</h6>
            <p class="text-muted small">Добавьте первое измерение</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Таймер сервера -->
<div class="text-center text-muted small mt-3">
  Сервер: <%= Time.now.strftime('%d.%m.%Y %H:%M') %> | 
  Локально: <span id="local-time"></span>
</div>

<style>
.compact-timer {
  text-align: center;
}

.timer-badge {
  padding: 0.5rem 1rem;
  border-radius: 8px;
  color: white;
  font-weight: 600;
  font-size: 1.1rem;
  font-family: 'Courier New', monospace;
}

.accordion-button {
  font-size: 0.9rem;
  font-weight: 500;
}

.accordion-button:not(.collapsed) {
  background-color: var(--main-color-light);
  color: var(--main-color-dark);
}

.accordion-body {
  padding: 0.75rem;
}

.form-control-sm, .form-select-sm {
  font-size: 0.85rem;
}

.table th, .table td {
  padding: 0.5rem;
  font-size: 0.85rem;
}

.btn-sm {
  padding: 0.25rem 0.5rem;
  font-size: 0.8rem;
  min-height: auto;
}

.card-header {
  padding: 0.75rem 1rem;
}

.card-body {
  padding: 1rem;
}

/* Адаптивность для мобильных */
@media (max-width: 768px) {
  .compact-timer {
    display: none;
  }
  
  .btn-group {
    flex-wrap: wrap;
    justify-content: end;
  }
  
  .table-responsive {
    font-size: 0.8rem;
  }
}
</style>

<script>
// Компактный таймер
class CompactTimer {
  constructor(patientId) {
    this.patientId = patientId;
    this.intervalId = null;
  }

  start() {
    this.updateTimer();
    this.intervalId = setInterval(() => this.updateTimer(), 1000);
  }

  async updateTimer() {
    try {
      const response = await fetch(`/timer/status/${this.patientId}`);
      const data = await response.json();
      
      this.updateDisplay(data);
    } catch (error) {
      console.error('Ошибка таймера:', error);
    }
  }

  updateDisplay(data) {
    const minutesEl = document.getElementById('compact-timer-minutes');
    const secondsEl = document.getElementById('compact-timer-seconds');
    const timerBadge = document.querySelector('.timer-badge');

    if (!minutesEl || data.delivery_completed || !data.labor_started) return;

    const totalSeconds = data.seconds || 0;
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;

    minutesEl.textContent = minutes.toString().padStart(2, '0');
    secondsEl.textContent = seconds.toString().padStart(2, '0');

    // Обновляем цвет таймера
    if (data.status === 'danger') {
      timerBadge.className = 'timer-badge bg-danger';
    } else if (data.status === 'warning') {
      timerBadge.className = 'timer-badge bg-warning';
    } else {
      timerBadge.className = 'timer-badge bg-success';
    }
  }
}

// Инициализация при загрузке
document.addEventListener('DOMContentLoaded', function() {
  const patientId = '<%= @patient.id %>';
  const patientStatus = '<%= @patient.status %>';
  const deliveryCompleted = <%= @patient.delivery_completed %>;

  if (patientStatus === 'в родах' && !deliveryCompleted) {
    const timer = new CompactTimer(patientId);
    timer.start();
  }

  // Локальное время
  function updateLocalTime() {
    const now = new Date();
    document.getElementById('local-time').textContent = 
      now.toLocaleDateString('ru-RU') + ' ' + now.toLocaleTimeString('ru-RU');
  }
  setInterval(updateLocalTime, 1000);
  updateLocalTime();
});
</script>